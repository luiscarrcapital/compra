import pandas as pd
import plotly.graph_objects as go
import webbrowser
import os
import base64

# Rutas
ruta_excel = r"C:\Users\Luis Iván Cordero\Downloads\datos.xlsx"
ruta_logo = r"C:\Users\Luis Iván Cordero\Downloads\logo.png"

# Cargar datos
df = pd.read_excel(ruta_excel)
x = df['Superficie']
y1 = df.iloc[:, 1]  # Propuesta
y2 = df.iloc[:, 2]  # Actual
y3 = df.iloc[:, 3]  # €/m² Propuesta
y4 = df.iloc[:, 4]  # €/m² Actual
superficies_clave = [3700, 4000, 4200, 4500, 4700]

# Codificar logo
with open(ruta_logo, "rb") as img_file:
    encoded_logo = base64.b64encode(img_file.read()).decode()

# Crear figura
fig = go.Figure()

# Líneas principales
fig.add_trace(go.Scatter(x=x, y=y1, mode='lines+markers', name='Propuesta',
                         line=dict(color="#041E42"), marker=dict(color="#041E42")))
fig.add_trace(go.Scatter(x=x, y=y2, mode='lines+markers', name='Actual',
                         line=dict(color="#788920"), marker=dict(color="#788920")))

# €/m² líneas secundarias
fig.add_trace(go.Scatter(x=x, y=y3, mode='lines', name='€/m² P.',
                         line=dict(color="#041E42", width=1, dash='dash'),
                         yaxis='y2'))
fig.add_trace(go.Scatter(x=x, y=y4, mode='lines', name='€/m² A.',
                         line=dict(color="#788920", width=1, dash='dash'),
                         yaxis='y2'))

# Anotaciones €/m² Propuesta
for s in superficies_clave:
    y_val = df.loc[df['Superficie'] == s, df.columns[3]].values[0]
    fig.add_annotation(
        x=s, y=y_val, yref='y2',
        text=f"{int(y_val):,}".replace(",", "."),
        showarrow=True, arrowhead=1, ax=0, ay=-20,
        font=dict(color="#041E42", family="Avenir Next LT Pro", size=12)
    )

# Anotaciones €/m² Actual
for s in superficies_clave:
    y_val = df.loc[df['Superficie'] == s, df.columns[4]].values[0]
    fig.add_annotation(
        x=s, y=y_val, yref='y2',
        text=f"{int(y_val):,}".replace(",", "."),
        showarrow=True, arrowhead=1, ax=0, ay=20,
        font=dict(color="#788920", family="Avenir Next LT Pro", size=12)
    )

# Anotaciones Valor Total Propuesta (muy desplazadas para evitar solapamientos)
for s in superficies_clave:
    y_val = df.loc[df['Superficie'] == s, df.columns[1]].values[0]
    fig.add_annotation(
        x=s + 60, y=y_val + 50000,
        text=f"{int(y_val):,}".replace(",", "."),
        showarrow=False,
        font=dict(color="#041E42", family="Avenir Next LT Pro", size=12),
        bgcolor="rgba(255,255,255,0.85)",
        bordercolor="#041E42",
        borderwidth=1,
        borderpad=4
    )

# Anotaciones Valor Total Actual (muy desplazadas para evitar solapamientos)
for s in superficies_clave:
    y_val = df.loc[df['Superficie'] == s, df.columns[2]].values[0]
    fig.add_annotation(
        x=s - 60, y=y_val - 50000,
        text=f"{int(y_val):,}".replace(",", "."),
        showarrow=False,
        font=dict(color="#788920", family="Avenir Next LT Pro", size=12),
        bgcolor="rgba(255,255,255,0.85)",
        bordercolor="#788920",
        borderwidth=1,
        borderpad=4
    )

# Layout
fig.update_layout(
    title=dict(
        text="<b>Be Grand Almagro: Esquema de Compra</b>",
        font=dict(color="#333F48", size=20, family="Avenir Next LT Pro"),
        x=0.5
    ),
    xaxis=dict(
        title=dict(text="<b>Superficie (m²)</b>", font=dict(color="#333F48", size=14, family="Avenir Next LT Pro")),
        tickmode='array',
        tickvals=list(range(3700, 5201, 100)),
        ticktext=[f"{v:,}".replace(",", ".") for v in range(3700, 5201, 100)],
        tickfont=dict(color="#333F48", size=12, family="Avenir Next LT Pro")
    ),
    yaxis=dict(
        title=dict(text="<b>Valor (€)</b>", font=dict(color="#333F48", size=14, family="Avenir Next LT Pro")),
        tickformat=",",
        tickfont=dict(color="#333F48", size=12, family="Avenir Next LT Pro")
    ),
    yaxis2=dict(
        overlaying='y',
        side='right',
        showgrid=False,
        tickfont=dict(color="#333F48", size=12, family="Avenir Next LT Pro"),
        title=dict(text="<b>€/m²</b>", font=dict(color="#333F48", size=14, family="Avenir Next LT Pro"))
    ),
    legend=dict(font=dict(color="#333F48", size=12, family="Avenir Next LT Pro")),
    plot_bgcolor='#F2F2F2',
    images=[dict(
        source="data:image/png;base64," + encoded_logo,
        xref="paper", yref="paper",
        x=0, y=1.15,
        sizex=0.2, sizey=0.2,
        xanchor="left", yanchor="top",
        layer="above"
    )]
)

# Guardar HTML
output_path = os.path.join(os.getcwd(), "bg_almagro.html")
fig.write_html(output_path, include_plotlyjs="cdn", full_html=True)
webbrowser.open("file://" + output_path)
